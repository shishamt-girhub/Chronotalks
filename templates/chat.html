{% extends "base.html" %}

{% block title %}Chat with {{ leader_name }}{% endblock %}

{% block extra_css %}
<style>
.leader-info-panel {
    width: 450px !important;
    min-width: 450px;
}

.chat-section {
    flex: 1;
    min-width: 0;
}

.chat-container {
    gap: 2rem; 
}
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-section">
        <div class="chat-card">
            <div class="chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="fas fa-comments me-2"></i>Chat with {{ leader_name }}
                    </h5>
                    <div class="chat-controls">
                        <button class="btn" id="clearChat" title="Clear Chat">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="btn" id="downloadChat" title="Download Chat">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="chat-input-container">
                <form id="chatForm">
                    <input type="text" id="messageInput" placeholder="Type your message..." required>
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="leader-info-panel">
        <h4>
            <i class="fas fa-user-tie me-2"></i>{{ leader_name }}
        </h4>
        
        <div id="leaderImageContainer" style="display: none;">
            <img class="leader-image" alt="{{ leader_name }}" id="leaderImage">
        </div>
        
        <div class="leader-info-card">
            <h6>
                <i class="fas fa-info-circle me-2"></i>About
            </h6>
            <p id="leaderSummary">
                {% if leader_info and leader_info.summary %}
                    {{ leader_info.summary }}
                {% else %}
                    Information not available
                {% endif %}
            </p>
        </div>
        
        {% if leader_info and leader_info.wiki_url %}
            <a href="{{ leader_info.wiki_url }}" target="_blank" class="wiki-link">
                <i class="fas fa-external-link-alt me-2"></i>Read more on Wikipedia
            </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const leaderName = "{{ leader_name }}";
let chatHistory = [];

function getChatHistory() {
    try {
        const stored = localStorage.getItem(`chat_history_${leaderName}`);
        return stored ? JSON.parse(stored) : [];
    } catch (error) {
        console.error('Error reading from localStorage:', error);
        return [];
    }
}

function saveChatHistory() {
    try {
        localStorage.setItem(`chat_history_${leaderName}`, JSON.stringify(chatHistory));
    } catch (error) {
        console.error('Error saving to localStorage:', error);
    }
}

function clearChatHistory() {
    try {
        localStorage.removeItem(`chat_history_${leaderName}`);
    } catch (error) {
        console.error('Error clearing localStorage:', error);
    }
}

function loadLeaderImage() {
    const imageContainer = document.getElementById('leaderImageContainer');
    const image = document.getElementById('leaderImage');
    
    fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&titles=${encodeURIComponent(leaderName)}&prop=pageimages&pithumbsize=500&origin=*`)
        .then(response => response.json())
        .then(data => {
            const pages = data.query.pages;
            const pageId = Object.keys(pages)[0];
            const page = pages[pageId];
            
            if (page.thumbnail) {
                image.src = page.thumbnail.source;
                image.onload = function() {
                    imageContainer.style.display = 'block';
                };
                image.onerror = function() {
                    imageContainer.style.display = 'none';
                };
            } else {
                imageContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.log('Image not available');
            imageContainer.style.display = 'none';
        });
}

loadLeaderImage();

chatHistory = getChatHistory();

function addMessage(message, isUser = false, displayMessage = true) {
    const timestamp = new Date().toLocaleTimeString();
    
    const historyItem = {
        role: isUser ? 'user' : 'leader',
        content: message,
        timestamp: timestamp
    };
    chatHistory.push(historyItem);
    
    saveChatHistory();
    
    if (displayMessage) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        
        messageDiv.innerHTML = `
            <div class="message-content">${message}</div>
            <div class="timestamp">${timestamp}</div>
        `;
        
        document.getElementById('chatMessages').appendChild(messageDiv);
        messageDiv.scrollIntoView({ behavior: 'smooth' });
    }
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    addMessage(message, true, true);
    messageInput.value = '';
    
    showTypingIndicator();
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                leader_name: leaderName
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        hideTypingIndicator();
        addMessage(data.response, false, true);
        
    } catch (error) {
        hideTypingIndicator();
        addMessage(`Error: ${error.message}`, false, true);
    }
});

document.getElementById('clearChat').addEventListener('click', function() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('chatMessages').innerHTML = '';
        chatHistory = [];
        
        clearChatHistory();
    }
});

document.getElementById('downloadChat').addEventListener('click', function() {
    const chatData = {
        leader: leaderName,
        timestamp: new Date().toISOString(),
        messages: chatHistory
    };
    
    const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_with_${leaderName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

if (chatHistory.length === 0) {
    addMessage(`Hello! I am ${leaderName}. How may I assist you today?`, false, true);
} else {
    addMessage(`Welcome back! I am ${leaderName}. How may I assist you today?`, false, true);
}
</script>
{% endblock %} 